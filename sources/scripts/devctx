#!/usr/bin/env bash
# devctx - Open a development context (project) in kitty + zellij
#
# Scans project directories for git repos and worktrees, lets you pick one
# via rofi, and opens a kitty window with a zellij session in that directory.
#
# Usage: devctx
# Typically bound to an i3 keybinding.

set -euo pipefail

PROJECT_DIRS=("$HOME/Workspace" "$HOME/Documents/perso/projects" "$HOME/Workspace/worktrees")

# Gather all candidate directories
candidates=()
for root in "${PROJECT_DIRS[@]}"; do
    [[ -d "$root" ]] || continue
    for project in "$root"/*/; do
        [[ -d "$project" ]] || continue
        # Regular git repo (.git dir) or git worktree (.git file)
        if [[ -d "${project}.git" || -f "${project}.git" ]]; then
            candidates+=("$project")
        fi
    done
done

if [[ ${#candidates[@]} -eq 0 ]]; then
    notify-send "devctx" "No projects found"
    exit 1
fi

# Format for display: show relative to home
display=()
for c in "${candidates[@]}"; do
    display+=("${c/#$HOME\//~/}")
done

# Pick via rofi
selected=$(printf '%s\n' "${display[@]}" | rofi -dmenu -p "project" -i)
[[ -z "$selected" ]] && exit 0

# Expand ~ back
target="${selected/#\~/$HOME}"

# Open kitty with zellij session (unset ZELLIJ so it doesn't attach to parent)
# Delete dead sessions to avoid broken resurrection, then attach -c for create-or-attach
session_name=$(basename "$target")
zellij delete-session "$session_name" 2>/dev/null || true
env -u ZELLIJ kitty --directory "$target" --title "dev: $session_name" \
    zellij attach "$session_name" -c &

disown
